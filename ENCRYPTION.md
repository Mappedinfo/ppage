# 内容加密功能使用指南

PPage 提供了强大的内容加密功能，可以保护您的私密内容，只有输入正确密码才能查看。

## 功能特性

✨ **核心功能**

- 🔐 AES-256-GCM 加密算法，带盐值处理，确保高安全性
- 🔑 密码保护：只有知道密码的用户才能查看加密内容
- 🎯 文件夹级别加密：支持对指定文件夹进行批量加密
- 🚫 自动隔离：加密内容不参与文档关系图谱和搜索索引
- 💾 会话缓存：密码在会话期间保存，刷新后需重新输入
- 🎨 友好界面：提供美观的密码输入界面

## 快速开始

### 1. 启用加密功能

编辑 `public/config.yml`，启用加密功能并配置受保护的文件夹：

```yaml
# 内容加密配置
encryption:
  # 启用加密功能
  enabled: true

  # 受保护的文件夹列表
  protectedFolders:
    - 'content/protected' # 私密内容文件夹
    - 'content/private' # 可以添加多个

  # 加密内容不参与文档关系图谱和搜索
  excludeFromGraph: true
  excludeFromSearch: true
```

### 2. 创建受保护的内容

在配置的文件夹中创建 Markdown 文件：

```bash
mkdir -p content/protected
echo "---
title: 私密笔记
date: 2025-01-08
---

# 这是我的私密内容

这些内容只有知道密码的人才能看到。
" > content/protected/my-private-note.md
```

### 3. 加密内容

在提交到 git 之前，运行加密脚本：

```bash
npm run encrypt
```

脚本会提示您输入加密密码（需要输入两次确认）：

```
🔐 内容加密工具
==================================================

📁 受保护的文件夹: content/protected

找到 3 个文件

🔑 请输入加密密码: ******
🔑 请再次输入密码以确认: ******

🔒 开始加密文件...
  ✅ 加密成功: content/protected/my-private-note.md
  ✅ 加密成功: content/protected/diary.md
  ✅ 加密成功: content/protected/thoughts.md

==================================================
📊 加密完成！
  ✅ 成功: 3 个
  ⏭️  跳过: 0 个
  ❌ 失败: 0 个

✨ 所有文件加密成功！现在可以提交到 git 了。
```

### 4. 提交加密后的内容

```bash
git add content/protected
git commit -m "Add encrypted content"
git push
```

### 5. 查看加密内容

当访问加密的内容时，页面会自动弹出密码输入框：

- 输入正确的密码即可解锁内容
- 密码在会话期间保存，无需重复输入
- 刷新页面后需要重新输入密码

## 工作原理

### 加密流程

1. **本地加密**
   - 使用 `npm run encrypt` 命令
   - 读取配置的受保护文件夹
   - 使用 AES-256-GCM 算法加密内容
   - 每次加密使用随机盐值和 IV，确保安全性
   - 加密后的内容保存在原文件中，带有特殊标记

2. **Git 提交**
   - 加密后的文件可以安全地提交到公开仓库
   - 即使代码公开，内容也无法被解密

3. **构建部署**
   - 加密的文件正常参与构建
   - 生成的网站包含加密内容

4. **访问解密**
   - 用户访问加密内容时自动检测
   - 弹出密码输入框
   - 输入正确密码后在浏览器中解密
   - 密码存储在 sessionStorage，刷新后失效

### 安全机制

- **AES-256-GCM**：业界标准的加密算法
- **PBKDF2**：密钥派生函数，增加暴力破解难度（100,000 次迭代）
- **随机盐值**：每次加密使用不同的盐值，防止彩虹表攻击
- **认证标签**：确保数据完整性，防止篡改
- **会话缓存**：密码不持久化存储，更加安全

## 文件结构

加密后的 Markdown 文件结构：

```markdown
---
title: 私密笔记
date: 2025-01-08
encrypted: true
encryptedAt: '2025-01-08T12:00:00.000Z'
---

<!-- ENCRYPTED_CONTENT -->

base64编码的加密内容...

<!-- /ENCRYPTED_CONTENT -->
```

## 最佳实践

### 密码管理

1. **使用强密码**
   - 至少 12 位字符
   - 包含大小写字母、数字和特殊字符
   - 不要使用常见密码

2. **密码分享**
   - 通过安全渠道分享密码（如加密通讯软件）
   - 避免通过邮件或公开渠道发送

3. **定期更新**
   - 定期更换密码
   - 重新加密所有文件

### 内容组织

1. **文件夹分类**

   ```
   content/
   ├── posts/          # 公开博客
   ├── pages/          # 公开页面
   └── protected/      # 加密内容
       ├── diary/      # 日记
       ├── notes/      # 笔记
       └── drafts/     # 草稿
   ```

2. **使用多个密码**
   - 可以为不同文件夹使用不同密码
   - 需要多次运行 `npm run encrypt`

### 备份建议

1. **保留原始文件**
   - 加密前备份原始文件到本地
   - 不要将原始文件提交到 git

2. **密码备份**
   - 将密码安全存储（如密码管理器）
   - 确保不会忘记密码

## 常见问题

### Q: 忘记密码怎么办？

A: 如果忘记密码，加密的内容将无法解密。建议：

- 从本地备份恢复原始文件
- 重新设置新密码并加密

### Q: 可以使用不同密码吗？

A: 可以。您可以：

- 为不同的文件夹配置不同的受保护路径
- 分别运行加密脚本并使用不同密码
- 用户访问时需要输入对应的密码

### Q: 加密内容会被搜索引擎收录吗？

A: 不会。加密的内容：

- 以密文形式存储
- 搜索引擎无法解析内容
- 即使收录也只是乱码

### Q: 性能影响如何？

A: 解密操作在浏览器中完成：

- 现代浏览器性能良好
- 解密通常在 100ms 内完成
- 只在首次访问时需要输入密码

### Q: 可以在手机上查看吗？

A: 可以。加密功能完全支持移动设备：

- 响应式密码输入界面
- 在移动浏览器中正常解密
- 会话缓存在移动端也有效

## 技术细节

### 加密算法参数

- **算法**: AES-256-GCM
- **密钥长度**: 256 bits (32 bytes)
- **IV 长度**: 128 bits (16 bytes)
- **盐值长度**: 512 bits (64 bytes)
- **认证标签**: 128 bits (16 bytes)
- **PBKDF2 迭代次数**: 100,000

### 数据格式

加密数据结构（Base64 编码前）：

```
[Salt (64 bytes)] + [IV (16 bytes)] + [Auth Tag (16 bytes)] + [Encrypted Data]
```

### 浏览器兼容性

需要浏览器支持：

- Web Crypto API
- SessionStorage API
- ES6+ JavaScript

支持的浏览器：

- Chrome 60+
- Firefox 57+
- Safari 11+
- Edge 79+

## 相关文件

- `scripts/crypto.js` - 加密/解密核心算法（Node.js）
- `scripts/encrypt.js` - 加密脚本（CLI）
- `src/utils/encryption.js` - 前端解密工具
- `src/components/common/PasswordPrompt.jsx` - 密码输入组件
- `src/components/common/ProtectedContent.jsx` - 受保护内容组件

## 许可证

此功能是 PPage 项目的一部分，遵循项目的开源许可证。

## 贡献

欢迎提交 Issue 和 Pull Request 来改进加密功能！
